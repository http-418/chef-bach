#!/bin/sh
################################################
#
#              Generated by Chef
#
################################################
<% subnet = @node[:bcpc][:management][:subnet] %>
# Add default routes as a safety net, then remove all at the end
ip route add default via <%=@node["bcpc"]["networks"][subnet]["management"]["gateway"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         table main
ip route add <%=@node["bcpc"]["networks"][subnet]["management"]["cidr"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         scope link src <%=@node["bcpc"]["management"]["ip"]%> \
         table main
<% if node[:bcpc]["networks"][subnet][:management][:interface] != node[:bcpc]["networks"][subnet][:storage][:interface] %>
ip route add <%=@node["bcpc"]["networks"][subnet]["storage"]["cidr"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["storage"]["interface"]%> \
         scope link src <%=@node["bcpc"]["storage"]["ip"]%> \
         table main
<% end %>

# Build routing table for management network
ip route flush table mgmt
ip route add default via <%=@node["bcpc"]["networks"][subnet]["management"]["gateway"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         table mgmt
ip route add <%=@node["bcpc"]["networks"][subnet]["management"]["cidr"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         scope link src <%=@node["bcpc"]["management"]["ip"]%> \
         table mgmt

# Activate this routing table for management traffic
ip rule del pref 10000
ip rule del pref 10001
ip rule add from <%=@node["bcpc"]["networks"][subnet]["management"]["cidr"]%> pref 10000 table mgmt
ip rule add to <%=@node["bcpc"]["networks"][subnet]["management"]["cidr"]%> pref 10001 table mgmt

<% if node[:bcpc]["networks"][subnet][:management][:interface] != node[:bcpc]["networks"][subnet][:storage][:interface] %>
# Build routing table for storage network
ip route flush table storage
ip route add default via <%=@node["bcpc"]["networks"][subnet]["storage"]["gateway"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["storage"]["interface"]%> \
         table storage
ip route add <%=@node["bcpc"]["networks"][subnet]["storage"]["cidr"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["storage"]["interface"]%> \
         scope link src <%=@node["bcpc"]["storage"]["ip"]%> \
         table storage

# Activate this routing table for storage traffic
ip rule del pref 10002
ip rule del pref 10003
ip rule add from <%=@node["bcpc"]["networks"][subnet]["storage"]["cidr"]%> pref 10002 table storage
ip rule add to <%=@node["bcpc"]["networks"][subnet]["storage"]["cidr"]%> pref 10003 table storage
<% end %>

# Drop all routes to other networks from the main routing table
# XXX: The following line is intentionally duplicated to remove multiple default routes
ip route del default dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         table main
ip route del default dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         table main
<% if node[:bcpc]["networks"][subnet][:management][:interface] != node[:bcpc]["networks"][subnet][:storage][:interface] %>
ip route del default dev <%=@node["bcpc"]["networks"][subnet]["storage"]["interface"]%> \
         table main
<% end %>
ip route del <%=@node["bcpc"]["networks"][subnet]["management"]["cidr"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         table main
<% if node[:bcpc]["networks"][subnet][:management][:interface] != node[:bcpc]["networks"][subnet][:storage][:interface] %>
ip route del <%=@node["bcpc"]["networks"][subnet]["storage"]["cidr"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["storage"]["interface"]%> \
         table main
<% end %>

# Flush the route cache to make sure these are active
ip route flush cache
