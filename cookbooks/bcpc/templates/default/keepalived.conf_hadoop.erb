# -*- mode: conf-unix -*-
################################################
#
#              Generated by Chef
#
################################################
<% subnet = node[:bcpc][:management][:subnet] %>
global_defs {
  router_id <%="#{node[:hostname]}"%>
}

vrrp_script chk_haproxy {
  script "killall -0 haproxy"
  interval 1
}

vrrp_sync_group VG1_<%="#{node[:bcpc][:region_name]}"%> {
  group {
    VI1_<%="#{node[:bcpc][:region_name]}"%>
    VI2_<%="#{node[:bcpc][:region_name]}"%>
    <% if node[:bcpc][:networks].length > 1 %>
    <%= "GLOBAL_VIP_#{node[:bcpc][:region_name]}" %>
    <% end %>
  }
}

vrrp_instance VI1_<%="#{node[:bcpc][:region_name]}"%> {
  virtual_router_id <%="#{get_config('keepalived-router-id')}"%>

  # for electing MASTER, highest priority wins.
  priority  <%= "#{255 - (node[:bcpc][:node_number].to_i) % 255}" %>
  state     BACKUP
  nopreempt

  interface <%= "#{node[:bcpc][:networks][subnet][:management][:interface]}" %>

  virtual_ipaddress {
    <%="#{node[:bcpc][:networks][subnet][:management][:vip]}/#{(node['bcpc'][:networks][subnet]['management']['cidr'].match /\d+\.\d+\.\d+\.\d+\/(\d+)/)[1].to_i}"%>
  }
  track_script {
    chk_haproxy
  }
  authentication {
    auth_type PASS
    auth_pass <%="#{get_config!('password','keepalived','os')}"%>
  }
}

vrrp_instance VI2_<%="#{node[:bcpc][:region_name]}"%> {
  virtual_router_id <%="#{get_config('keepalived-router-id').to_i+1}"%>

  # for electing MASTER, highest priority wins.
  priority  <%= "#{255 - (node[:bcpc][:node_number].to_i % 255)}" %>
  state     BACKUP
  nopreempt

  interface <%= "#{node[:bcpc][:networks][subnet][:floating][:interface]}" %>

  virtual_ipaddress {
    <%="#{node[:bcpc][:networks][subnet][:floating][:vip]}/#{(node['bcpc'][:networks][subnet]['floating']['cidr'].match /\d+\.\d+\.\d+\.\d+\/(\d+)/)[1].to_i}"%>
  }
  track_script {
    chk_haproxy
  authentication {
    auth_type PASS
    auth_pass <%="#{get_config('keepalived-password')}"%>
  }
}

vrrp_instance GLOBAL_VIP_<%="#{node[:bcpc][:region_name]}"%> {
  virtual_router_id <%="#{get_config('keepalived-router-id').to_i+2}"%>

  # for electing MASTER, highest priority wins.
  priority  <%= "#{255-node[:bcpc][:node_number].to_i}" %>
  state     BACKUP
  nopreempt

  interface <%= "#{node[:bcpc][:networks][subnet][:management][:interface]}" %>

  virtual_ipaddress {
    <%="#{node[:bcpc][:management][:vip]}/32"%>
  }
  track_script {
    chk_haproxy
  authentication {
    auth_type PASS
    auth_pass <%="#{get_config!('password','keepalived','os')}"%>
  }
}
